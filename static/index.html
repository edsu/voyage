<!doctype html>
<html>

  <head>
    <title>WRLC Checkouts</title>
    <link rel="stylesheet" href="/static/style.css"></style>
  </head>

  <body>

    <h1>WRLC Checkouts</h1>
    <section id="checkouts">
    </section>

    <script src="http://gsf.github.io/whiskers.js/whiskers.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script id="bookTemplate" type="text/template">
      <article class="book">
        <img class="thumbnail" src="http://covers.openlibrary.org/b/isbn/{isbn}-M.jpg">
        <a href="http://findit.library.gwu.edu/item/{id}" class="title">{title}</a>
        <br>
        {if author}
        <span class="author">{author}</span>
        <br>
        {/if}
        <span class="place">{placeOfPublication}</span>
        <span class="publisher">{publisher}</span>
        <span class="pubDate">{publicationDate}</span>
        {if isbn}
        <br>
        ISBN: {isbn}
        {/if}

        <footer>
        <time datetime="{charge.created}">{charge.time}</time> - 
        checked out at
        {if charge.library.url}
        <a href="{charge.library.url}" class="library">{charge.library.name}</a>
        {else}
        <span class="library">{charge.library.name}</span>
        {/if}
        {if differentOwner}
          owned by
          {if owner.url}
          <a class="library" href="{owner.url}">{owner.name}</a>
          {else}
          <span class="library">{owner.name}</span>
          {/if}
        {/if}
        </footer>
      </article>
    </script>

    <script>
      var bookTemplate = $("#bookTemplate").html();

      function run() {
        var socket = io.connect();
        socket.on('checkout', addCheckout);
      }

      function pad(n) {
        return ('00' + n).slice(-2)
      }

      function addCheckout(book) {
        var t = new Date(book.charge.created);
        // format the chargeTime datetime as HH:MM
        book.charge.time = pad(t.getHours()) + ':' + 
                           pad(t.getMinutes()) + ':' + 
                           pad(t.getSeconds());
        book.differentOwner = book.charge.library.name != book.owner.name;
        var update = $(whiskers.render(bookTemplate, book));
        update.hide();
        $("#checkouts").prepend(update);
        update.slideDown();
      }

      $(run);
    </script>

  </body>

</html>
